<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>Service Manager API</title>
        <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-2.0.3.min.js"></script>
        <script>
            var uri = 'api/services';

            $(document).ready(function () {
                $.getJSON(uri)
                    .done(function (data) {
                        // On success, 'data' contains a list of services.
                        $.each(data, function (key, item) {
                            // Add a list item for the services.
                            var serviceId = getItemID(item);
                            $('<li onclick="deleteItemByID(' + serviceId + ')">').text(formatItem(item)).attr({ id: serviceId }).appendTo($('#services'));
                        });
                    });
            });

            function deleteItemByID(serviceId) {
                var id = serviceId;

                $.ajax({
                    url: 'api/services/' + id,
                    type: 'DELETE',
                    dataType: 'json',
                    data: id,
                    success: function (data, textStatus, jqxhl) {
                        setTimeout(function () {
                            location.reload();
                        }, 1000);
                    },
                    error: function (jqxhr, textStatus, errorThrown) {
                        console.log('Error: ' + errorThrown);
                    }
                });
            }

            function getItemID(item) {
                return item.Id;
            }

            function formatItem(item) {
                return item.ServiceName + ': ' + item.Description;
            }

            function findServiceByID() {
                var id = $('#serviceId').val();
                $.getJSON(uri + '/' + id)
                    .done(function (data) {
                        $('#service').text(formatItem(data));
                        $('#serviceName').val(data.ServiceName);
                        $('#description').val(data.Description);
                    })
                    .fail(function (jqxhr, textStatus, errorThrown) {
                        $('#service').text('Error: ' + errorThrown);
                    });
            }

            function updateItem() {
                var id = $('#serviceId').val();
                var serviceName = $('#serviceName').val();
                var description = $('#description').val();
                var service = new Object();
                service.ServiceName = serviceName;
                service.Description = description;
                var json = JSON.stringify(service);

                $.ajax({
                    url: 'api/services/' + id,
                    type: 'PUT',
                    dataType: 'json',
                    data: {serviceName: serviceName, description: description },
                    success: function (data, textStatus, jqxhr) {
                        console.log(data);
                        setTimeout(function () {
                            location.reload();
                        }, 1000);
                    },
                    error: function (jqxhr, textStatus, error) {
                        console.log(error);
                    }
                })
            }
        </script>
        <script type="text/javascript">
            $("#serviceForm").submit(function () {
                //var jqxhr = $.post('api/services', $('#serviceForm').serialize())
                $.ajax({
                    url: 'api/services',
                    type: 'POST',
                    data: data,
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function () {
                        var loc = jqxhr.getResponseHeader('Location');
                        var a = $('<a/>', { href: loc, text: loc });
                        $('#message').html(a);
                    },
                    error: function () {
                        $('#message').html("Error posting the update.");
                    }
                });
                return false;
            });
        </script>
    </head>

    <body>
        <header>
            <h1>
                Service Manager API
            </h1>
        </header>

        <main>
            <div>
                <h2>All Services</h2>
                <ul id="services" />
            </div>

            <hr />
            <div>
                <h2>Search Services by ID</h2>
                <input type="text" id="serviceId" />
                <input type="button" value="Search" onclick="findServiceByID();" />
                <br />
                <p id="service" />
                <br />
                <div>
                    <label for="service">Service Name: </label>
                    <input type="text" name="service" id="serviceName" />
                    <label for="description">Description: </label>
                    <input type="text" name="description" id="description" />
                </div>
                <input type="button" value="Edit" onclick="updateItem()"/>
            </div>

            <hr />
            <h2>Create a Service</h2>
            <form id="serviceForm" action="/api/services" method="post" enctype="application/x-www-form-urlencoded">
                <div>
                    <label for="serviceName">Service Name: </label>
                </div>
                <div>
                    <input name="serviceName" type="text" />
                </div>
                <div>
                    <label for="description">Description: </label>
                </div>
                <div>
                    <input name="description" type="text" />
                </div>
                <br />
                <div>
                    <input type="submit" value="Submit" />
                </div>
            </form>          
        </main>
            
        <footer>
            <h5>
                Alexander Yanev - Web API
            </h5>
        </footer>
    </body>
</html>